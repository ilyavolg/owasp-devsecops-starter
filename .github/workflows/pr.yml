name: security-pr
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug list files
        run: ls -la

      - name: Gitleaks (SARIF)
  run: |
    docker run --rm -v "$PWD":/repo zricethezav/gitleaks:latest \
      detect -s /repo --no-git --redact \
      --report-format sarif -r /repo/gitleaks.sarif || true

- name: Semgrep (OWASP Top 10) (SARIF)
  run: |
    docker run --rm -v "$PWD":/src returntocorp/semgrep:latest \
      semgrep --config p/owasp-top-ten --sarif -o /src/semgrep.sarif || true

- name: Trivy filesystem (SARIF) + SBOM
  run: |
    docker run --rm -v "$PWD":/repo aquasec/trivy:latest \
      fs --format sarif -o /repo/trivy-fs.sarif /repo || true
    docker run --rm -v "$PWD":/repo aquasec/trivy:latest \
      sbom --format cyclonedx -o /repo/sbom.cdx.json /repo || true

- name: Build demo image
  run: docker build -t devsecops-demo:${{ github.sha }} .

- name: Trivy image scan (SARIF)
  run: |
    docker run --rm \
      -v "$PWD":/repo \
      -v /var/run/docker.sock:/var/run/docker.sock \
      aquasec/trivy:latest image \
      --format sarif -o /repo/trivy-img.sarif devsecops-demo:${{ github.sha }} || true

- name: Checkov IaC (SARIF)
  run: |
    docker run --rm -v "$PWD":/src bridgecrew/checkov:latest \
      -d /src -o sarif > checkov.sarif || true

- name: List reports
  run: ls -lh *.sarif sbom.cdx.json zap-baseline.* || true

- name: Upload artifacts
  uses: actions/upload-artifact@v4
  with:
    name: pr-security-artifacts
    path: |
      gitleaks.sarif
      semgrep.sarif
      trivy-fs.sarif
      trivy-img.sarif
      checkov.sarif
      sbom.cdx.json
      zap-baseline.html
      zap-baseline.json
    if-no-files-found: warn


